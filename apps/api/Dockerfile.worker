FROM node:20-slim

WORKDIR /usr/src/app/api

COPY package*.json ./

# Install docker CLI (docker.io) so the worker can spawn docker containers,
# plus dos2unix and node tooling. Keep cleaning apt lists to keep image small.
RUN apt-get update && apt-get install -y dos2unix docker.io && \
    npm install -g ts-node typescript && \
    npm install && \
    dos2unix ./node_modules/.bin/ts-node && \
    chmod 755 ./node_modules/.bin/ts-node && \
    chmod -R 755 ./node_modules/.bin && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

COPY . .

RUN chmod -R 755 /usr/src/app

CMD ["npx", "ts-node", "src/workers/submission.worker.ts"]
